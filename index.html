<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DC — Comics Tracker</title>

  <!-- Supabase UMD: основной CDN + фолбэк -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script>
    if(!window.supabase){
      var s=document.createElement('script');
      s.src='https://unpkg.com/@supabase/supabase-js@2';
      document.head.appendChild(s);
    }
  </script>

  <style>
    :root{
      --bg:#0f1115;--card:#141826;--muted:#1a2031;--border:#242b3d;
      --text:#e7ecff;--text-dim:#aab3d9;--accent:#5AA7FF;
      --ok:#2bd27c;--warn:#ff6b7a;--shadow:0 10px 30px rgba(0,0,0,.35);
      --rad:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 10px}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:920px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.9));backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid var(--border)}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:20px;letter-spacing:.3px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--card);cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .right{display:flex;gap:8px;align-items:center}
    .btn,button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;box-shadow:var(--shadow)}
    .btn.accent{background:var(--accent);border-color:transparent;color:#061224}
    .btn.ghost{background:transparent}
    .input{flex:1;min-width:200px;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--muted);color:var(--text)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{padding:6px 10px;border-radius:999px;background:var(--muted);border:1px solid var(--border);cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--rad);box-shadow:var(--shadow);padding:12px}
    .row{display:flex;gap:10px;align-items:flex-start}
    .thumb{width:96px;height:96px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#0b0d12}
    .meta{font-size:13px;color:var(--text-dim)}
    .kebab{margin-left:auto;background:transparent;border:1px solid var(--border);border-radius:10px;padding:6px;cursor:pointer}
    .hidden{display:none !important}

    /* Обрезка описания в ленте до 2 строк */
    .clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

    /* Меню ⋯ */
    .menu{position:relative}
    .menu-btn{border:1px solid var(--border);background:var(--card);border-radius:999px;padding:8px 10px;cursor:pointer}
    .menu-btn:after{content:"⋯";font-size:18px;line-height:1}
    .dropdown{position:absolute;top:calc(100% + 8px);right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);min-width:200px;display:none;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dd-item{display:block;width:100%;text-align:left;border:none;background:transparent;color:var(--text);padding:10px 12px;cursor:pointer}
    .dd-item:hover{background:var(--muted)}

    /* Chapter view */
    .gallery{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .gal-img{width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid var(--border);background:#0b0d12;cursor:pointer}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--muted);color:var(--text-dim);font-size:13px;margin-right:6px}

    /* Fullscreen lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:1000}
    .lightbox img{max-width:95vw;max-height:92vh;border-radius:16px}
    .lightbox.show{display:flex}

    /* Editor */
    .form{display:grid;gap:10px}
    .two{display:grid;gap:8px;grid-template-columns:1fr 1fr}
    .field label{display:block;font-size:13px;color:var(--text-dim);margin-bottom:6px}
    .urls{display:flex;gap:8px;flex-wrap:wrap}
    .thumb-sm{width:72px;height:72px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#0b0d12}
    .pill{padding:8px 12px;border-radius:999px;border:1px dashed var(--border);cursor:pointer}
    .danger{background:rgba(255,107,122,.12);border-color:#ff6b7a;color:#ffb0b7}
    .success{background:rgba(43,210,124,.12);border-color:#2bd27c;color:#82efb5}

    /* Toast (Undo) */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0b0d12;border:1px solid var(--border);border-radius:999px;padding:10px 14px;display:flex;gap:8px;align-items:center;z-index:2000;box-shadow:var(--shadow)}
    .toast .undo{background:var(--accent);border:none;border-radius:999px;padding:6px 10px;color:#061224;cursor:pointer}

    /* FAB */
    .fab{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#061224;border:none;border-radius:999px;padding:14px 16px;font-size:18px;box-shadow:var(--shadow);cursor:pointer;z-index:900}

    /* Auth modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal .box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;max-width:420px;width:92%}
    .muted{color:var(--text-dim)}

    /* ===== Mobile tweaks ===== */
    @media(max-width: 520px){
      .wrap{ padding: 10px }
      .bar{ gap:8px; flex-wrap:wrap; padding:10px 12px }
      .brand h1{ font-size:18px }
      .tabs{ overflow-x:auto; -webkit-overflow-scrolling:touch; gap:6px }
      .tabs::-webkit-scrollbar{ display:none }

      .grid{ grid-template-columns: 1fr }
      .card.row{ flex-direction:column; align-items:stretch }
      .thumb{ width:100%; height:180px }
      .card{ position:relative }
      .kebab{ position:absolute; top:8px; right:8px }

      .gallery{ display:flex; gap:8px; overflow-x:auto; padding-bottom:6px; -webkit-overflow-scrolling:touch }
      .gal-img{ flex:0 0 42vw; height:42vw }

      .two{ grid-template-columns: 1fr }
      .pill{ width:100%; text-align:center }

      .fab{ right:16px; bottom: calc(16px + env(safe-area-inset-bottom)); padding:16px 18px; font-size:20px }
    }
    @supports(padding:max(0px)){
      body{ padding-bottom: max(0px, env(safe-area-inset-bottom)) }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <h1>DC</h1>
        <nav class="tabs">
          <button class="tab" data-route="#/feed">Feed</button>
          <button class="tab" data-route="#/series">Series</button>
          <button class="tab" data-route="#/tags">Tags</button>
        </nav>
      </div>
      <div class="right">
        <!-- Меню ⋯: почта спрятана здесь -->
        <div class="menu" id="menu">
          <button class="menu-btn" id="menu-btn" aria-label="Menu"></button>
          <div class="dropdown" id="menu-dd" role="menu" aria-hidden="true">
            <div class="muted" style="padding:10px 12px" id="auth-status-menu">guest</div>
            <button id="btn-login" class="dd-item">Log in</button>
            <button id="btn-logout" class="dd-item hidden">Log out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- FEED -->
    <section id="view-feed" class="hidden">
      <div class="search">
        <input id="search" class="input" placeholder="Search (title / series / tag / year…)" autocomplete="off" />
        <div id="suggest" class="chips"></div>
        <button id="btn-clear" class="btn ghost">Clear</button>
      </div>
      <div id="feed" class="grid" style="margin-top:12px"></div>
    </section>

    <!-- SERIES -->
    <section id="view-series" class="hidden">
      <div class="row" style="justify-content:flex-end;margin-bottom:8px">
        <button id="series-add" class="btn">＋ New series</button>
      </div>
      <div id="series" class="grid"></div>
    </section>

    <!-- TAGS -->
    <section id="view-tags" class="hidden">
      <div id="tags" class="chips"></div>
      <div id="tags-info" class="muted" style="margin:8px 0"></div>
      <div id="tag-feed" class="grid" style="margin-top:12px"></div>
    </section>

    <!-- CHAPTER VIEW -->
    <section id="view-chapter" class="hidden">
      <div id="chapter-box" class="card"></div>
    </section>

    <!-- EDITOR -->
    <section id="view-editor" class="hidden">
      <div class="card">
        <h2 id="ed-title">New chapter</h2>
        <div class="form">
          <div class="two">
            <div class="field"><label>Series</label>
              <select id="ed-series" class="input"></select>
            </div>
            <div class="field"><label>Year (optional)</label>
              <input id="ed-year" class="input" type="number" min="1900" max="2100" />
            </div>
          </div>
          <div class="two">
            <div class="field"><label>Title (optional)</label>
              <input id="ed-title-input" class="input" placeholder="e.g. The Court of Owls"/>
            </div>
            <div class="field"><label>Number (#issue, optional)</label>
              <input id="ed-issue" class="input" type="number" min="0" />
            </div>
          </div>
          <div class="field"><label>Summary (optional)</label>
            <textarea id="ed-summary" class="input" rows="4" placeholder="Short notes"></textarea>
          </div>
          <div class="two">
            <div class="field"><label>Link A (optional)</label>
              <input id="ed-link-a" class="input" placeholder="https://…"/>
            </div>
            <div class="field"><label>Link B (optional)</label>
              <input id="ed-link-b" class="input" placeholder="https://…"/>
            </div>
          </div>
          <div class="field">
            <label>Tags (comma-separated, optional)</label>
            <input id="ed-tags" class="input" placeholder="batman, detective, night"/>
            <div id="tag-suggest" class="chips"></div>
          </div>

          <div class="field">
            <label>Images</label>
            <div class="urls">
              <input id="ed-image-urls" class="input" placeholder="Paste image URLs, comma-separated" />
              <label class="pill">
                <!-- без accept / capture => откроется файловый менеджер -->
                <input id="ed-file" type="file" multiple hidden />
                Upload from device
              </label>
            </div>
            <div id="ed-previews" class="gallery"></div>
            <div class="muted" style="font-size:12px;margin-top:4px">
              If thumbnails are enabled, small copies are created for fast feed.
            </div>
          </div>

          <div class="row" style="justify-content:flex-end;gap:8px;margin-top:6px">
            <button id="ed-delete" class="btn danger hidden">Delete</button>
            <button id="ed-close" class="btn">Close</button>
            <button id="ed-save" class="btn accent">Save</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- FAB -->
  <button id="fab" class="fab hidden" title="Add chapter">＋</button>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true"><img alt=""></div>

  <!-- Auth modal -->
  <div id="auth-modal" class="modal" aria-hidden="true">
    <div class="box">
      <h3>Log in (email & password)</h3>
      <p class="muted">Редактировать может только владелец.</p>
      <div class="form" style="margin-top:8px">
        <div class="field"><label>Email</label><input id="login-email" class="input" placeholder="you@example.com"></div>
        <div class="field"><label>Password</label><input id="login-pass" class="input" type="password" placeholder="••••••••"></div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="auth-cancel" class="btn">Cancel</button>
          <button id="auth-go" class="btn accent">Log in</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"><span id="toast-msg"></span><button id="toast-undo" class="undo">Undo</button></div>

<script>
/*** ====== CONFIG ====== ***/
const SUPABASE_URL = "https://miyyoppwehfitpftqjlh.supabase.co";  // твой URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1peXlvcHB3ZWhmaXRwZnRxamxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczOTEwMjAsImV4cCI6MjA3Mjk2NzAyMH0.Z3PZAfK5chLvNns8YvwUA5ODaAy_YOogj5-K8yBh5LY"; // твой ANON KEY
const BUCKET = "images";
const USE_THUMBS = true; // миниатюры в Storage

const OWNER_UID = "1c11591d-a27c-4023-adec-f1aeeace822c"; // только этот UID редактирует

// init supabase
let supabase = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

/*** ====== STATE ====== ***/
const state = { user:null, isMember:false, route:"#/feed", undo:null, tagFilter:[] };

/*** ====== HELPERS ====== ***/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = x => x ?? "—";
const show = (el, on=true)=> el.classList.toggle("hidden", !on);
const html = (el, str) => el.innerHTML = str;
function setTabs(){ $$(".tab").forEach(t=> t.classList.toggle("active", t.dataset.route===state.route)); }
function toast(message, onUndo){
  const box=$("#toast"); $("#toast-msg").textContent=message; show(box,true);
  const undoBtn=$("#toast-undo"); const handler=()=>{ clearTimeout(state.undo?.timer); show(box,false); onUndo?.(); };
  undoBtn.addEventListener('click', handler, { once:true });
  const timer=setTimeout(()=> show(box,false), 5000); state.undo={ timer };
}

/*** ====== AUTH ====== ***/
async function refreshAuth(){
  const { data:{ user } } = await supabase.auth.getUser();
  state.user = user;
  $("#auth-status-menu").textContent = user ? (user.email || "user") : "guest";
  show($("#btn-login"), !user);
  show($("#btn-logout"), !!user);
  show($("#fab"), !!user && user.id===OWNER_UID);
  state.isMember = !!user && user.id===OWNER_UID;
}
function openAuth(){ const m=$("#auth-modal"); m.style.display="flex"; m.setAttribute("aria-hidden","false"); }
function closeAuth(){ const m=$("#auth-modal"); m.style.display="none"; m.setAttribute("aria-hidden","true"); }

$("#btn-login").onclick = openAuth;
$("#auth-cancel").onclick = closeAuth;
$("#auth-go").onclick = async ()=>{
  const email=$("#login-email").value.trim(), pass=$("#login-pass").value;
  try{
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if(error) throw error;
    closeAuth(); await refreshAuth(); routeTo("#/feed");
  }catch(e){ alert(e.message || e); }
};
$("#btn-logout").onclick = async ()=>{ await supabase.auth.signOut(); await refreshAuth(); routeTo("#/feed"); };

/* ⋯ menu toggle + outside click */
const menu = $("#menu");
$("#menu-btn").onclick = (e)=>{
  e.stopPropagation();
  menu.classList.toggle("open");
  $("#menu-dd").setAttribute("aria-hidden", !menu.classList.contains("open"));
};
document.addEventListener("click", (e)=>{
  if(!menu.contains(e.target)) {
    menu.classList.remove("open");
    $("#menu-dd").setAttribute("aria-hidden","true");
  }
});

/*** ====== ROUTER ====== ***/
window.addEventListener("hashchange", ()=> routeTo(location.hash || "#/feed"));
function routeTo(hash){
  state.route = hash || "#/feed";
  setTabs();
  ["#view-feed","#view-series","#view-tags","#view-chapter","#view-editor"].forEach(id=> show($(id),false));
  if(hash.startsWith("#/feed")) renderFeed();
  else if(hash.startsWith("#/series")) renderSeries();
  else if(hash.startsWith("#/tags")) renderTags();
  else if(hash.startsWith("#/chapter/")) renderChapter(Number(hash.split("/")[2]));
  else if(hash.startsWith("#/edit")){ const parts=hash.split("/"); renderEditor(parts[2]?Number(parts[2]):null); }
  else renderFeed();
}

/*** ====== DATA LOADERS ====== ***/
async function getSeries(){
  const { data, error } = await supabase.from("series").select("id,title").order("title");
  if(error) throw error;
  const { data: ch } = await supabase.from("chapters").select("series_id");
  const map={}; (ch||[]).forEach(c=> map[c.series_id]=(map[c.series_id]||0)+1);
  return (data||[]).map(s=> ({...s, count: map[s.id]||0}));
}
async function getTagsWithCounts(){
  const { data: tags } = await supabase.from("tags").select("id,name").order("name");
  const { data: rel }  = await supabase.from("chapter_tags").select("tag_id");
  const map={}; (rel||[]).forEach(r=> map[r.tag_id]=(map[r.tag_id]||0)+1);
  return (tags||[]).map(t=>({id:t.id,name:t.name,count:map[t.id]||0})).sort((a,b)=>b.count-a.count);
}
async function getFeed(){
  const { data: chapters } = await supabase
    .from("chapters")
    .select("id,title,issue_num,year,series_id,summary,images,link_a,link_b,series:series_id(title)")
    .order("created_at",{ ascending:false }).limit(200);

  const { data: rel } = await supabase.from("chapter_tags").select("chapter_id, tags:id:tag_id(name)");
  const tagMap={}; (rel||[]).forEach(r=>{ if(r.tags){ (tagMap[r.chapter_id]=tagMap[r.chapter_id]||[]).push(r.tags.name); }});
  return (chapters||[]).map(c=> ({...c, tags: tagMap[c.id]||[]}));
}
async function getChapterById(id){
  const { data, error } = await supabase.from("chapters").select("*, series:series_id(title)").eq("id",id).single();
  if(error) throw error;
  const { data: rel } = await supabase.from("chapter_tags").select("chapter_id, tags:id:tag_id(name)").eq("chapter_id",id);
  const tags=(rel||[]).map(r=> r.tags?.name).filter(Boolean);
  return { ...data, tags };
}

/*** ====== THUMBNAILS ====== ***/
function thumbUrl(url){
  if(!USE_THUMBS) return url;
  try{
    const u=new URL(url);
    if(!u.pathname.includes("/storage/v1/object/public/"+BUCKET+"/")) return url;
    const parts=u.pathname.split("/"); const fname=parts.pop();
    const base=fname.replace(/\.[^.]+$/,''); const thumbName=base+"_thumb.jpg";
    parts.push(thumbName); u.pathname=parts.join("/"); return u.toString();
  }catch(_){ return url; }
}

/*** ====== FEED: единый поиск + подсказки ====== ***/
async function renderFeed(){
  show($("#view-feed"), true);
  html($("#feed"), `<div class="card">Loading…</div>`);

  const list = await getFeed();
  const searchEl = $("#search");
  const suggestEl = $("#suggest");
  $("#btn-clear").onclick = ()=>{ searchEl.value=""; renderFiltered(list,""); };

  function makeSuggestions(q){
    const s = q.trim().toLowerCase();
    if(!s){ suggestEl.innerHTML=""; return; }
    const years = new Set(), titles = new Set(), tags = new Set();
    for(const c of list){
      if(String(c.year||"").startsWith(s)) years.add(String(c.year));
      if((c.title||"").toLowerCase().startsWith(s)) titles.add(c.title);
      if((c.series?.title||"").toLowerCase().startsWith(s)) titles.add(c.series.title);
      for(const t of (c.tags||[])) if(t.toLowerCase().startsWith(s)) tags.add("#"+t);
      if(years.size>5 && titles.size>5 && tags.size>5) break;
    }
    const chips = [...years].slice(0,6).map(x=>`<button class="chip" data-fill="${x}">${x}</button>`)
      .concat([...titles].slice(0,6).map(x=>`<button class="chip" data-fill="${x}">${x}</button>`))
      .concat([...tags].slice(0,6).map(x=>`<button class="chip" data-fill="${x}">${x}</button>`))
      .join("");
    suggestEl.innerHTML = chips;
    $$("#suggest .chip").forEach(b=> b.onclick = ()=>{ searchEl.value=b.dataset.fill.replace(/^#/,""); renderFiltered(list, searchEl.value); });
  }

  function renderFiltered(items, q){
    q = (q||"").trim().toLowerCase();
    makeSuggestions(q);
    const filtered = items.filter(c=>{
      const base = `${c.title||""} ${c.series?.title||""} ${(c.tags||[]).join(" ")} ${c.year||""}`.toLowerCase();
      return !q || base.includes(q);
    });
    if(filtered.length===0){ html($("#feed"), `<div class="card">No results</div>`); return; }

    const out = filtered.map(c=>{
      const cover = c.images?.[0] || "";
      const summary = c.summary ? escapeHtml(c.summary) : "";
      return `
      <div class="card row" onclick="openChapter(${c.id})" title="Open chapter">
        ${cover ? `<img class="thumb" loading="lazy" referrerpolicy="no-referrer" src="${thumbUrl(cover)}" alt="">` : `<div class="thumb"></div>`}
        <div style="flex:1">
          <div><strong>#${fmt(c.issue_num)} — ${c.title||"—"}</strong></div>
          <div class="meta">${c.series?.title||"—"} • ${fmt(c.year)}</div>
          ${summary ? `<div class="meta clamp-2" style="margin-top:4px">${summary}</div>` : ``}
          <div class="meta">${(c.tags||[]).map(t=>`<span class="badge">${t}</span>`).join("")}</div>
        </div>
        ${state.isMember ? `<button class="kebab" onclick="event.stopPropagation(); editChapter(${c.id})">⋯</button>` : ``}
      </div>`;
    }).join("");
    html($("#feed"), out);
  }

  renderFiltered(list, $("#search").value || "");
  searchEl.oninput = debounce(()=> renderFiltered(list, searchEl.value), 150);
}
function openChapter(id){ location.hash = `#/chapter/${id}`; }
function editChapter(id){ location.hash = `#/edit/${id}`; }

/*** ====== SERIES ====== ***/
async function renderSeries(){
  show($("#view-series"), true);
  html($("#series"), `<div class="card">Loading…</div>`);
  const data=await getSeries();
  const out=(data||[]).map(s=>`
    <div class="card row" onclick="openSeries(${s.id})">
      <div style="font-weight:700">${s.title}</div>
      <div class="meta" style="margin-left:auto">${s.count} chapters</div>
    </div>`).join("");
  html($("#series"), out || `<div class="card">No series</div>`);

  const addBtn=$("#series-add");
  if(addBtn){
    addBtn.onclick = async ()=>{
      if(!state.isMember) return alert("Login as owner to edit.");
      const name=prompt("Series title:"); if(!name) return;
      const { error } = await supabase.from("series").insert({ title:name.trim() });
      if(error) return alert(error.message);
      renderSeries();
    };
  }
}
async function openSeries(seriesId){
  const { data: name } = await supabase.from("series").select("title").eq("id", seriesId).single();
  show($("#view-feed"), true); show($("#view-series"), false); show($("#view-tags"), false);
  $("#search").value = name?.title || ""; renderFeed();
}

/*** ====== TAGS ====== ***/
async function renderTags(){
  show($("#view-tags"), true);
  html($("#tags"), `Loading…`);
  const tags=await getTagsWithCounts();
  html($("#tags"), tags.length ? tags.map(t=>`<button class="chip" data-tag="${t.name}">${t.name} (${t.count})</button>`).join("") : `<span class="muted">No tags yet</span>`);
  $("#tags-info").textContent = "Tap tags to filter; tap again to unselect · Clear with Feed → Clear";
  html($("#tag-feed"), ``);

  const feed = await getFeed();
  const active = new Set();

  function renderByTags(){
    const selected = [...active];
    const filtered = selected.length ? feed.filter(c=> selected.every(t=> (c.tags||[]).includes(t))) : feed;
    const out = filtered.map(c=>{
      const cover = c.images?.[0] || "";
      return `
      <div class="card row" onclick="openChapter(${c.id})">
        ${cover ? `<img class="thumb" loading="lazy" referrerpolicy="no-referrer" src="${thumbUrl(cover)}">` : `<div class="thumb"></div>`}
        <div style="flex:1">
          <div><strong>#${fmt(c.issue_num)} — ${c.title||"—"}</strong></div>
          <div class="meta">${c.series?.title||"—"} • ${fmt(c.year)}</div>
          <div class="meta">${(c.tags||[]).map(t=>`<span class="badge">${t}</span>`).join("")}</div>
        </div>
      </div>`;
    }).join("");
    html($("#tag-feed"), out || `<div class="card">No results</div>`);
  }

  $$("#tags .chip").forEach(b=>{
    b.onclick = ()=>{
      b.classList.toggle("active");
      const name = b.dataset.tag;
      if(b.classList.contains("active")) active.add(name); else active.delete(name);
      renderByTags();
    };
  });
}

/*** ====== CHAPTER VIEW ====== ***/
async function renderChapter(id){
  show($("#view-chapter"), true);
  const box=$("#chapter-box");
  html(box, `Loading…`);
  try{
    const c=await getChapterById(id);
    let prev=null, next=null;
    if(c.series_id!=null && c.issue_num!=null){
      const { data: siblings } = await supabase.from("chapters").select("id,issue_num").eq("series_id", c.series_id).order("issue_num");
      const idx=(siblings||[]).findIndex(s=> s.id===id); prev=siblings?.[idx-1]?.id||null; next=siblings?.[idx+1]?.id||null;
    }
    const links = `
      ${c.link_a? `<a class="btn" target="_blank" href="${c.link_a}">Link A</a>`:``}
      ${c.link_b? `<a class="btn" target="_blank" href="${c.link_b}">Link B</a>`:``}
    `;
    html(box, `
      <div class="row" style="gap:12px;align-items:flex-start">
        <div style="flex:1">
          <h2>#${fmt(c.issue_num)} — ${c.title||"—"}</h2>
          <div class="meta">${c.series?.title||"—"} • ${fmt(c.year)}</div>
          <div style="margin:8px 0">${links}</div>
          <p>${c.summary ? escapeHtml(c.summary).replace(/\n/g,"<br>") : "<span class='muted'>No summary</span>"}</p>
          <div>${(c.tags||[]).map(t=> `<span class="badge">${t}</span>`).join("")}</div>
          <div class="gallery">
            ${(c.images||[]).map(u=> `<img class="gal-img" loading="lazy" referrerpolicy="no-referrer" src="${thumbUrl(u)}" alt="" onclick="openLightbox('${u}')">`).join("")}
          </div>
          <div class="row" style="gap:8px;margin-top:8px">
            ${prev? `<button class="btn" onclick="openChapter(${prev})">← Prev</button>`:``}
            ${next? `<button class="btn" onclick="openChapter(${next})">Next →</button>`:``}
            ${state.isMember? `<button class="btn" onclick="editChapter(${id})">Edit</button>`:``}
            ${state.isMember? `<button class="btn danger" onclick="deleteChapter(${id})">Delete</button>`:``}
          </div>
        </div>
      </div>
    `);
  }catch(e){ html(box, `<div class="card">Error: ${e.message}</div>`); }
}
function openLightbox(src){ const lb=$("#lightbox"); lb.querySelector("img").src=src; lb.classList.add("show"); }
$("#lightbox").onclick = ()=> $("#lightbox").classList.remove("show");

/*** ====== EDITOR ====== ***/
$("#fab").onclick = ()=> location.hash = "#/edit";
async function renderEditor(id){
  if(!state.isMember){ alert("Login as owner to edit."); routeTo("#/feed"); return; }
  show($("#view-editor"), true);
  $("#ed-title").textContent=id? "Edit chapter" : "New chapter";
  show($("#ed-delete"), !!id);

  // series select (+ создать новую)
  const series=await getSeries();
  const options = `<option value="">— select —</option>` +
    series.map(s=> `<option value="${s.id}">${s.title}</option>`).join("") +
    `<option value="_new">＋ New series…</option>`;
  html($("#ed-series"), options);
  $("#ed-series").onchange = async ()=>{
    if($("#ed-series").value === "_new"){
      const name = prompt("New series title:");
      if(!name){ $("#ed-series").value=""; return; }
      const { data, error } = await supabase.from("series").insert({ title:name.trim() }).select().single();
      if(error){ alert(error.message); $("#ed-series").value=""; return; }
      const s2 = await getSeries();
      html($("#ed-series"), `<option value="">— select —</option>` + s2.map(s=> `<option value="${s.id}">${s.title}</option>`).join("") + `<option value="_new">＋ New series…</option>`);
      $("#ed-series").value = data.id;
    }
  };

  // reset
  $("#ed-title-input").value=""; $("#ed-issue").value=""; $("#ed-year").value="";
  $("#ed-summary").value=""; $("#ed-link-a").value=""; $("#ed-link-b").value="";
  $("#ed-tags").value=""; $("#ed-image-urls").value=""; html($("#ed-previews"),"");

  // tag suggestions (топ-30)
  const tagList = await getTagsWithCounts();
  const topTags = tagList.slice(0,30).map(t=>t.name);
  html($("#tag-suggest"), topTags.map(n=>`<button class="chip" data-name="${n}">#${n}</button>`).join(""));
  $$("#tag-suggest .chip").forEach(b=>{
    b.onclick = ()=>{
      const name = b.dataset.name;
      const inp = $("#ed-tags");
      const cur = inp.value.trim();
      const list = cur ? cur.split(",").map(s=>s.trim()).filter(Boolean) : [];
      if(!list.includes(name)) list.push(name);
      inp.value = list.join(", ");
    };
  });

  let existing=null;
  if(id){
    existing=await getChapterById(id);
    $("#ed-title-input").value=existing.title||"";
    $("#ed-issue").value=existing.issue_num||"";
    $("#ed-year").value=existing.year||"";
    $("#ed-summary").value=existing.summary||"";
    $("#ed-link-a").value=existing.link_a||"";
    $("#ed-link-b").value=existing.link_b||"";
    $("#ed-tags").value=(existing.tags||[]).join(", ");
    $("#ed-series").value=existing.series_id;
    (existing.images||[]).forEach(addPreview);
  }

  $("#ed-file").onchange = async (ev)=>{
    const files=Array.from(ev.target.files||[]);
    for(const f of files){
      if(!f.type.startsWith("image/")) continue;
      try{
        const { originalUrl } = await uploadImageWithThumb(f);
        addPreview(originalUrl);
      }catch(e){ alert("Upload error: "+(e.message||e)); }
    }
    ev.target.value="";
  };
  $("#ed-image-urls").onchange = ()=>{
    const raw=$("#ed-image-urls").value.trim(); if(!raw) return;
    raw.split(",").map(s=>s.trim()).filter(Boolean).forEach(addPreview);
    $("#ed-image-urls").value="";
  };

  $("#ed-save").onclick = async ()=>{
    const payload={
      series_id: Number($("#ed-series").value),
      title: $("#ed-title-input").value.trim() || "(untitled)",
      issue_num: $("#ed-issue").value ? Number($("#ed-issue").value) : null,
      year: $("#ed-year").value ? Number($("#ed-year").value) : null,
      summary: $("#ed-summary").value.trim() || null,
      link_a: $("#ed-link-a").value.trim() || null,
      link_b: $("#ed-link-b").value.trim() || null,
      images: $$("#ed-previews img").map(img=> img.dataset.original || img.src),
    };
    const tags=$("#ed-tags").value.split(",").map(s=> s.trim()).filter(Boolean);
    if(!payload.series_id){ alert("Select series"); return; }

    try{
      if(id){
        const before=existing;
        const { error } = await supabase.from("chapters").update(payload).eq("id", id);
        if(error) throw error;
        await upsertTagsForChapter(id, tags);
        toast("Saved. Undo?", async ()=>{
          await supabase.from("chapters").update({
            series_id:before.series_id,title:before.title,issue_num:before.issue_num,year:before.year,
            summary:before.summary,link_a:before.link_a,link_b:before.link_b,images:before.images
          }).eq("id", id);
          await upsertTagsForChapter(id, before.tags||[]); renderChapter(id);
        });
        openChapter(id);
      }else{
        const { data, error } = await supabase.from("chapters").insert(payload).select().single();
        if(error) throw error;
        await upsertTagsForChapter(data.id, tags);
        toast("Created. Undo?", async ()=>{
          await supabase.from("chapter_tags").delete().eq("chapter_id", data.id);
          await supabase.from("chapters").delete().eq("id", data.id);
          routeTo("#/feed");
        });
        openChapter(data.id);
      }
    }catch(e){ alert(e.message||e); }
  };

  $("#ed-close").onclick = ()=> history.back();
  $("#ed-delete").onclick = async ()=>{
    if(!confirm("Delete this chapter?")) return;
    const backup=await getChapterById(id);
    await supabase.from("chapter_tags").delete().eq("chapter_id", id);
    const { error } = await supabase.from("chapters").delete().eq("id", id);
    if(error){ alert(error.message); return; }
    toast("Deleted. Undo?", async ()=>{
      const { data: created } = await supabase.from("chapters").insert({
        id:backup.id, series_id:backup.series_id, title:backup.title, issue_num:backup.issue_num, year:backup.year,
        summary:backup.summary, link_a:backup.link_a, link_b:backup.link_b, images:backup.images
      }).select().single();
      await upsertTagsForChapter(created.id, backup.tags||[]); openChapter(created.id);
    });
    routeTo("#/feed");
  };
}
function addPreview(url){
  const wrap=document.createElement("div"); wrap.style.position="relative";
  const img=document.createElement("img");
  img.src=thumbUrl(url); img.dataset.original=url; img.className="thumb-sm";
  img.loading="lazy"; img.referrerPolicy="no-referrer";
  const rm=document.createElement("button"); rm.textContent="×"; rm.title="Remove";
  rm.style.position="absolute"; rm.style.top="-6px"; rm.style.right="-6px";
  rm.style.border="1px solid var(--border)"; rm.style.background="var(--warn)"; rm.style.color="#061224";
  rm.style.borderRadius="999px"; rm.style.cursor="pointer"; rm.style.width="22px"; rm.style.height="22px";
  rm.onclick=()=> wrap.remove(); wrap.append(img, rm); $("#ed-previews").appendChild(wrap);
}

/*** ====== TAGS UPSERT ====== ***/
async function upsertTagsForChapter(chapterId, tags){
  const unique=Array.from(new Set(tags.map(t=> t.toLowerCase())));
  if(unique.length){
    await supabase.from("tags").upsert(unique.map(name=>({name})), { onConflict:"name" });
    const { data: all } = await supabase.from("tags").select("id,name").in("name", unique);
    await supabase.from("chapter_tags").delete().eq("chapter_id", chapterId);
    const rels=(all||[]).map(t=> ({ chapter_id:chapterId, tag_id:t.id }));
    if(rels.length) await supabase.from("chapter_tags").insert(rels);
  }else{
    await supabase.from("chapter_tags").delete().eq("chapter_id", chapterId);
  }
}

/*** ====== IMAGE UPLOAD (с миниатюрой) ====== ***/
async function downscaleImage(file, maxSide=2000, mime='image/jpeg', quality=0.9){
  const url=URL.createObjectURL(file);
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; });
  const ratio=Math.min(maxSide/img.width, maxSide/img.height, 1);
  const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio);
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const blob=await new Promise(res=> canvas.toBlob(res, mime, quality)); URL.revokeObjectURL(url);
  return new File([blob], (file.name.replace(/\.[^.]+$/,'')||'image')+'.jpg', { type:mime });
}
async function makeThumb(file, maxSide=480, mime='image/jpeg', quality=0.85){ return downscaleImage(file, maxSide, mime, quality); }
function safeName(name){ return name.replace(/[^a-z0-9_.-]/gi,'_'); }
function pathJoin(...a){ return a.join('/').replace(/\/+/g,'/'); }

async function uploadImageWithThumb(file){
  const prepared = file.size>1_200_000 ? await downscaleImage(file, 2000, 'image/jpeg', 0.9) : file;
  if(!USE_THUMBS){
    const y=new Date().getFullYear(); const base=Date.now()+"_"+safeName(prepared.name.replace(/\.[^.]+$/,'')); const origPath=pathJoin(String(y), base+".jpg");
    const up=await supabase.storage.from(BUCKET).upload(origPath, prepared, { upsert:false, contentType:prepared.type||'image/jpeg' });
    if(up.error){ alert(up.error.message); throw up.error; }
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(origPath);
    return { originalUrl: pub.publicUrl, thumbUrl: pub.publicUrl };
  }
  const thumb = await makeThumb(file, 480, 'image/jpeg', 0.85);
  const y=new Date().getFullYear(); const base=Date.now()+"_"+safeName(prepared.name.replace(/\.[^.]+$/,'')); 
  const origPath=pathJoin(String(y), base+".jpg"); const thumbPath=pathJoin(String(y), base+"_thumb.jpg");

  // upsert:false — чтобы не ловить конфликт и странный stack depth
  const up1=await supabase.storage.from(BUCKET).upload(origPath, prepared, { upsert:false, contentType:prepared.type||'image/jpeg' });
  if(up1.error){ alert(up1.error.message); throw up1.error; }
  const up2=await supabase.storage.from(BUCKET).upload(thumbPath, thumb, { upsert:false, contentType:thumb.type||'image/jpeg' });
  if(up2.error){ alert(up2.error.message); throw up2.error; }

  const { data: pub1 } = supabase.storage.from(BUCKET).getPublicUrl(origPath);
  const { data: pub2 } = supabase.storage.from(BUCKET).getPublicUrl(thumbPath);
  return { originalUrl: pub1.publicUrl, thumbUrl: pub2.publicUrl };
}

/*** ====== ACTIONS ====== ***/
async function deleteChapter(id){
  if(!state.isMember){ alert("Login as owner to delete."); return; }
  if(!confirm("Delete this chapter?")) return;
  const backup=await getChapterById(id);
  await supabase.from("chapter_tags").delete().eq("chapter_id", id);
  const { error } = await supabase.from("chapters").delete().eq("id", id);
  if(error){ alert(error.message); return; }
  toast("Deleted. Undo?", async ()=>{
    const { data: created } = await supabase.from("chapters").insert({
      id:backup.id, series_id:backup.series_id, title:backup.title, issue_num:backup.issue_num, year:backup.year,
      summary:backup.summary, link_a:backup.link_a, link_b:backup.link_b, images:backup.images
    }).select().single();
    await upsertTagsForChapter(created.id, backup.tags||[]); openChapter(created.id);
  });
  routeTo("#/feed");
}

/*** ====== UTILS ====== ***/
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function escapeHtml(s){ return s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }

/*** ====== INIT ====== ***/
$$(".tab").forEach(b=> b.onclick = ()=> location.hash = b.dataset.route);
(async function init(){
  await refreshAuth();
  routeTo(location.hash || "#/feed");
})();
</script>
</body>
</html>
